
<!doctype html>
<html>

<head>
	<title>Scatter Chart</title>
	<meta charset="UTF-8">

	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.js"></script>

	<style>
	canvas {
		-moz-user-select: none;
		-webkit-user-select: none;
		-ms-user-select: none;
	}
    input[type=number]{
        width: 50px;

    }
	</style>
</head>

<body>
	<h1>画像マーカー散布図</h1>
	<p>下のような形式のCSVファイル(1列目：x, 2列目:y, 3列目:画像ファイル)を読み込むと、指定した画像をマーカーに使った散布図を生成します。このhtmlファイルをローカルに保存し、画像ファイルはご自身で用意してお使い下さい。</p>
	<pre>
身長[cm],  体重[kg],  image
155,       48,        icons/mano.jpg
154,       43,        icons/hiori.jpg
157,       46,        icons/meguru.jpg
	</pre>
	<div>
		<input type="file" id="inputfile" accept=".csv"/>
	</div>
	<div class="chart-container" style="position: relative; margin: 30px; height:80vh; width:80vw; float: left;">
		<canvas id="canvas"></canvas>
    </div>
    <div id="settings" style="float:left;">
        <table>
            <tr><td>X min: </td><td><input type="number" id="xmin"></td></tr>
            <tr><td>X max: </td><td><input type="number" id="xmax"></td></tr>
            <tr><td>Y min: </td><td><input type="number" id="ymin"></td></tr>
            <tr><td>Y max: </td><td><input type="number" id="ymax"></td></tr>
            <tr><td>Icon size: </td><td><input type="number" id="icon_size"></td></tr>
        </table>
        <input type="button" onclick="btn_settings();" value="設定を更新">
    </div>


	<script>

let chart = null;
let xmin, xmax, ymin, ymax;
let icon_size = 64;

function btn_settings(){
    const size = document.getElementById('icon_size').value;
    if (size){
        icon_size = size;
        open_file();
    }

    let value = null;
    xmin = parseFloat(document.getElementById('xmin').value);
    //chart.options.scales.xAxes[0].ticks.min = value ? value : null;
    if (!isNaN(xmin)) chart.options.scales.xAxes[0].ticks.min = xmin;

    xmax = parseFloat(document.getElementById('xmax').value);
    //if (value) chart.options.scales.xAxes[0].ticks.max = value;
    if (!isNaN(xmax)) chart.options.scales.xAxes[0].ticks.max = xmax;

    ymin = parseFloat(document.getElementById('ymin').value);
    if (!isNaN(ymin)) chart.options.scales.yAxes[0].ticks.min = ymin;

    ymax = parseFloat(document.getElementById('ymax').value);
    if (!isNaN(ymax)) chart.options.scales.yAxes[0].ticks.max = ymax;

    chart.update();
}

function img(src){
    let img = new Image();
    img.src =src;
    img.width = icon_size;
    img.height = icon_size;
    return img;
}

function max(arr){
    let m = arr.reduce(function(a, b) {
        return Math.max(a, b);
    });
    return m;
}

function min(arr){
    let m = arr.reduce(function(a, b) {
        return Math.min(a, b);
    });
    return m;
}

function open_file(){
    const inputfile = document.getElementById('inputfile').files[0];
    const reader = new FileReader();
    reader.readAsText(inputfile);
    reader.onload = function() {
        const lines = reader.result.split("\n");
        let datasets = [];
        let x_label = '';
        let y_label = '';
        let xs = [];
        let ys = [];
        for (let i = 0; i < lines.length; i++) {
            const items = lines[i].split(",");
            if (i == 0){
                x_label = items[0];
                y_label = items[1];
            } else if (items.length < 3){
                continue;
            } else {
                //console.log(items[0], items[1], items[2]);
                const x = parseFloat(items[0]);
                const y = parseFloat(items[1]);

                const data = {'data': [{'x': x, 'y': y}], 'pointStyle': img(items[2])};
                datasets.push(data);
                xs.push(x);
                ys.push(y);
                /*
                chart.data.datasets.forEach((dataset) => {
                    dataset.data.push(data);
                });
                */
                
            }

        };
        chart.data.datasets = datasets;
        chart.options.scales.yAxes[0].scaleLabel = {labelString: y_label, display: true,};
        chart.options.scales.xAxes[0].scaleLabel = {labelString: x_label, display: true,};
        
        chart.options.scales.xAxes[0].ticks.suggestedMin = xmin ? xmin : min(xs) - (max(xs) - min(xs))*0.1;
        chart.options.scales.xAxes[0].ticks.suggestedMax = xmax ? xmax : max(xs) + (max(xs) - min(xs))*0.1;
        chart.options.scales.yAxes[0].ticks.suggestedMin = ymin ? ymin : min(ys) - (max(ys) - min(ys))*0.1;
        chart.options.scales.yAxes[0].ticks.suggestedMax = ymax ? ymax : max(ys) + (max(ys) - min(ys))*0.1;
        
        chart.update();
        //console.log(chart.data.datasets);

    };
}

const inputfile = document.getElementById('inputfile');
inputfile.addEventListener("change", function(e) {
    open_file();


},false);



window.onload = function () {
    var ctx = document.getElementById('canvas').getContext('2d');

    const properties = {
        type: 'scatter',
        data: {
            datasets: [],
        },
        options: {
            legend: {
                display: false
            },
            responsive: true,
            maintainAspectRatio: false,
        }

    };
    chart = new Chart(ctx, properties);
};

	</script>



</body>

</html>
